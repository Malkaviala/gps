<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #ecf0f1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 2fr 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin: 0 0 20px 0;
            grid-column: 1 / -1;
            font-size: 2em;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .value {
            font-family: monospace;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 20px;
        }

        .status.online {
            background-color: #d4edda;
            color: var(--success-color);
        }

        .status.offline {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            color: var(--accent-color);
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .path-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @keyframes highlight {
            0% { background-color: var(--accent-color); color: white; }
            100% { background-color: #f8f9fa; color: var(--accent-color); }
        }

        .highlight {
            animation: highlight 1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GPS Tracker Dashboard</h1>
        
        <div id="map" class="panel"></div>
        
        <div class="panel">
            <div class="data-item">
                <span class="label">Latitude</span>
                <span class="value" id="lat">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Longitude</span>
                <span class="value" id="lon">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Altitude</span>
                <span class="value" id="alt">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Speed</span>
                <span class="value" id="speed">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Last Update</span>
                <span class="value" id="timestamp">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">CPU Temperature</span>
                <span class="value" id="temp">Loading...</span>
            </div>
            <div id="status" class="status">Connecting to tracker...</div>
        </div>

        <div class="panel">
            <h2>Trip Statistics</h2>
            <div class="stats-panel">
                <div class="stat-item">
                    <div class="stat-value" id="totalDistance">0.00</div>
                    <div class="stat-label">Total Distance (mi)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgSpeed">0.0</div>
                    <div class="stat-label">Avg Speed (mph)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxSpeed">0.0</div>
                    <div class="stat-label">Max Speed (mph)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="movementTime">0:00</div>
                    <div class="stat-label">Movement Time</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, marker, path;
        let locationHistory = [];
        const MAX_HISTORY_POINTS = 1000;
        let totalDistance = 0;
        let maxSpeed = 0;
        let movementStartTime = null;
        let totalMovementTime = 0;

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3P4c3HTpBIYkbqe_PRwSndGJfNQIZtDg",
            authDomain: "raspberrygps-36044.firebaseapp.com",
            databaseURL: "https://raspberrygps-36044-default-rtdb.firebaseio.com",
            projectId: "raspberrygps-36044",
            storageBucket: "raspberrygps-36044.appspot.com",
            messagingSenderId: "514392510539",
            appId: "1:514392510539:web:77df43576174b9377a57a7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959.87433; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }

        function updateStatistics(newData) {
            if (locationHistory.length > 0) {
                const prevLocation = locationHistory[locationHistory.length - 1];
                const distance = calculateDistance(
                    prevLocation.lat, prevLocation.lon,
                    newData.lat, newData.lon
                );
                
                if (distance > 0.0001) { // More than ~0.5 feet
                    totalDistance += distance;
                    document.getElementById('totalDistance').textContent = totalDistance.toFixed(2);
                    
                    // Update movement time
                    if (!movementStartTime) {
                        movementStartTime = new Date();
                    }
                } else if (movementStartTime) {
                    totalMovementTime += (new Date() - movementStartTime) / 60000; // Convert to minutes
                    movementStartTime = null;
                    document.getElementById('movementTime').textContent = formatDuration(totalMovementTime);
                }
            }

            // Update max speed
            const speed = parseFloat(newData.speed);
            if (speed > maxSpeed) {
                maxSpeed = speed;
                document.getElementById('maxSpeed').textContent = maxSpeed.toFixed(1);
            }

            // Calculate average speed
            if (totalMovementTime > 0) {
                const avgSpeed = totalDistance / (totalMovementTime / 60);
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            }
        }

        function updateMap(lat, lng) {
            if (!map || !marker) return;
            const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
            
            marker.setPosition(position);
            map.panTo(position);

            // Update path
            if (!path) {
                path = new google.maps.Polyline({
                    path: [position],
                    geodesic: true,
                    strokeColor: '#3498db',
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map
                });
            } else {
                const currentPath = path.getPath();
                currentPath.push(position);
                if (currentPath.getLength() > MAX_HISTORY_POINTS) {
                    currentPath.removeAt(0);
                }
            }
        }

        function initMap() {
            const defaultCenter = { lat: 35.3411073, lng: -80.8647512 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 17,
                mapTypeId: 'hybrid',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            marker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#3498db",
                    fillOpacity: 1,
                    strokeColor: "#fff",
                    strokeWeight: 2
                }
            });
        }

       // Listen for GPS data updates
       database.ref('/gps_data').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                try {
                    // Update display values with consistent precision
                    document.getElementById('lat').textContent = Number(data.lat).toFixed(6);  // 6 decimal places
                    document.getElementById('lon').textContent = Number(data.lon).toFixed(6);  // 6 decimal places
                    document.getElementById('alt').textContent = `${Number(data.alt).toFixed(2)} m`;  // 2 decimal places
                    document.getElementById('speed').textContent = `${Number(data.speed).toFixed(2)} mph`;  // 2 decimal places
                    document.getElementById('temp').textContent = `${Number(data.cpu_temperature).toFixed(1)}Â°C`;  // 1 decimal place
                    
                    // Format timestamp
                    const timestamp = new Date(data.timestamp);
                    document.getElementById('timestamp').textContent = timestamp.toLocaleString();
                    
                    // Update status
                    const timeDiff = (new Date() - timestamp) / 1000;
                    const status = document.getElementById('status');
                    if (timeDiff < 300) {
                        status.className = 'status online';
                        status.textContent = 'Tracker Online';
                    } else {
                        status.className = 'status offline';
                        status.textContent = 'Tracker Offline';
                    }

                    // Update location history and map
                    const position = {
                        lat: Number(data.lat),
                        lon: Number(data.lon),
                        speed: Number(data.speed),
                        timestamp: timestamp
                    };
                    
                    locationHistory.push(position);
                    if (locationHistory.length > MAX_HISTORY_POINTS) {
                        locationHistory.shift();
                    }

                    updateMap(position.lat, position.lon);
                    updateStatistics(position);
                    
                } catch (error) {
                    console.error('Error processing GPS data:', error);
                }
            }
        });
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASI0J9rev9-NmWnNmSV8gqG_uOOR1-19Y&callback=initMap">
    </script>
</body>
</html>
