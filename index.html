<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #ecf0f1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .value {
            font-family: monospace;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 20px;
        }

        .status.online {
            background-color: #d4edda;
            color: var(--success-color);
        }

        .status.offline {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            color: var(--accent-color);
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--primary-color);
        }

        @keyframes highlight {
            0% { background-color: var(--accent-color); color: white; }
            100% { background-color: #f8f9fa; color: var(--accent-color); }
        }

        .highlight {
            animation: highlight 1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">GPS Tracker Dashboard</h1>
        
        <div id="map" class="panel"></div>
        
        <!-- Location Panel -->
        <div class="panel">
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-map-marker-alt text-blue-500"></i>
                    <span class="text-gray-700 ml-2" id="address">Loading address...</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <i class="fas fa-compass text-blue-500"></i>
                    <span class="text-gray-700 ml-2" id="distance">Calculating distance...</span>
                </div>

                <button
                    onclick="openDirections()"
                    class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors flex items-center justify-center space-x-2"
                >
                    <i class="fas fa-directions text-white"></i>
                    <span class="ml-2">Get Directions</span>
                </button>
            </div>
        </div>

        <!-- Tracking Data Panel -->
        <div class="panel">
            <div class="data-item">
                <span class="label">Latitude</span>
                <span class="value" id="lat">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Longitude</span>
                <span class="value" id="lon">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Altitude</span>
                <span class="value" id="alt">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Speed</span>
                <span class="value" id="speed">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">Last Update</span>
                <span class="value" id="timestamp">Loading...</span>
            </div>
            <div class="data-item">
                <span class="label">CPU Temperature</span>
                <span class="value" id="temp">Loading...</span>
            </div>
            <div id="status" class="status">Connecting to tracker...</div>
        </div>

        <!-- Statistics Panel -->
        <div class="panel">
            <h2 class="text-xl font-semibold mb-4">Trip Statistics</h2>
            <div class="stats-panel">
                <div class="stat-item">
                    <div class="stat-value" id="totalDistance">0.00</div>
                    <div class="stat-label">Total Distance (mi)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgSpeed">0.0</div>
                    <div class="stat-label">Avg Speed (mph)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxSpeed">0.0</div>
                    <div class="stat-label">Max Speed (mph)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="movementTime">0:00</div>
                    <div class="stat-label">Movement Time</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, marker, path, geocoder;
        let locationHistory = [];
        const MAX_HISTORY_POINTS = 1000;
        let totalDistance = 0;
        let maxSpeed = 0;
        let movementStartTime = null;
        let totalMovementTime = 0;

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3P4c3HTpBIYkbqe_PRwSndGJfNQIZtDg",
            authDomain: "raspberrygps-36044.firebaseapp.com",
            databaseURL: "https://raspberrygps-36044-default-rtdb.firebaseio.com",
            projectId: "raspberrygps-36044",
            storageBucket: "raspberrygps-36044.appspot.com",
            messagingSenderId: "514392510539",
            appId: "1:514392510539:web:77df43576174b9377a57a7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959.87433; // Earth's radius in miles
            const lat1Rad = lat1 * Math.PI / 180;
            const lon1Rad = lon1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const lon2Rad = lon2 * Math.PI / 180;
            
            const dLat = lat2Rad - lat1Rad;
            const dLon = lon2Rad - lon1Rad;
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1Rad) * Math.cos(lat2Rad) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }

        function calculateDistanceFromUser(trackerLat, trackerLon) {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLat = position.coords.latitude;
                            const userLon = position.coords.longitude;
                            const distance = calculateDistance(userLat, userLon, trackerLat, trackerLon);
                            const formattedDistance = Number(distance).toFixed(2);
                            resolve(formattedDistance);
                        },
                        (error) => {
                            reject("Error getting user location: " + error.message);
                        }
                    );
                } else {
                    reject("Geolocation is not supported by this browser.");
                }
            });
        }

        function updateAddress(lat, lng) {
            const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
            
            geocoder.geocode({ location: latlng }, (results, status) => {
                const addressElement = document.getElementById('address');
                
                if (status === 'OK') {
                    if (results[0]) {
                        addressElement.textContent = results[0].formatted_address;
                    } else {
                        addressElement.textContent = 'Address not found';
                    }
                } else {
                    addressElement.textContent = 'Error fetching address';
                    console.error('Geocoder failed due to: ' + status);
                }
            });
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }

        function updateMap(lat, lng) {
            if (!map || !marker) return;
            
            lat = Number(Number(lat).toFixed(8));
            lng = Number(Number(lng).toFixed(8));
            
            const position = { lat, lng };
            
            marker.setPosition(position);
            map.panTo(position);

            if (!path) {
                path = new google.maps.Polyline({
                    path: [position],
                    geodesic: true,
                    strokeColor: '#3498db',
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map
                });
            } else {
                const currentPath = path.getPath();
                currentPath.push(position);
                if (currentPath.getLength() > MAX_HISTORY_POINTS) {
                    currentPath.removeAt(0);
                }
            }
        }

        function initMap() {
            const defaultCenter = { lat: 0, lng: 0 }; // Will be updated with first GPS reading
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 17,
                mapTypeId: 'hybrid',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            marker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#3498db",
                    fillOpacity: 1,
                    strokeColor: "#fff",
                    strokeWeight: 2
                }
            });

            geocoder = new google.maps.Geocoder();
        }

        let currentLat = null;
        let currentLng = null;

        function openDirections() {
            if (currentLat && currentLng) {
                const url = `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}`;
                window.open(url, '_blank');
            } else {
                console.error('No current location available');
                alert('Waiting for GPS location data...');
            }
        }

        // Listen for GPS data updates
        database.ref('/gps_data').on('value', async (snapshot) => {
            const data = snapshot.val();
            if (data) {
                try {
                    // Update current coordinates
                    currentLat = Number(data.lat).toFixed(8);
                    currentLng = Number(data.lon).toFixed(8);

                    // Update address
                    updateAddress(data.lat, data.lon);

                    // Update distance
                    try {
                        const distance = await calculateDistanceFromUser(data.lat, data.lon);
                        document.getElementById('distance').textContent = `Distance: ${distance} miles`;
                    } catch (error) {
                        console.error(error);
                        document.getElementById('distance').textContent = 'Unable to calculate distance';
                    }

                    // Update coordinates display
                    document.getElementById('lat').textContent = Number(data.lat).toFixed(8);
                    document.getElementById('lon').textContent = Number(data.lon).toFixed(8);
                    document.getElementById('alt').textContent = `${Number(data.alt).toFixed(2)} m`;
                    document.getElementById('speed').textContent = `${Number(data.speed).toFixed(2)} mph`;
                    document.getElementById('temp').textContent = `${Number(data.cpu_temperature).toFixed(1)}°C`;
                    
                    // Update timestamp and status
                    const timestamp = new Date(data.timestamp);
                    document.getElementById('timestamp').textContent = timestamp.toLocaleString();
                    
                    const timeDiff = (new Date() - timestamp) / 1000;
                    const status = document.getElementById('status');
                    if (timeDiff < 300) {
                        status.className = 'status online';
                        status.textContent = 'Tracker Online';
                    } else {
                        status.className = 'status offline';
                        status.textContent = 'Tracker Offline';
                    }

                    // Update location history and statistics
                    const position = {
                        lat: Number(Number(data.lat).toFixed(8)),
                        lon: Number(Number(data.lon).toFixed(8)),
                        speed: Number(data.speed),
                        timestamp: timestamp
                    };

                    // Update trip statistics
                    if (locationHistory.length > 0) {
                        const prevLocation = locationHistory[locationHistory.length - 1];
                        const movementDistance = calculateDistance(
                            prevLocation.lat, prevLocation.lon,
                            position.lat, position.lon
                        );
                        
                        if (movementDistance > 0.0001) {
                            totalDistance += movementDistance;
                            document.getElementById('totalDistance').textContent = totalDistance.toFixed(2);
                            
                            if (!movementStartTime) {
                                movementStartTime = new Date();
                            }
                        } else if (movementStartTime) {
                            totalMovementTime += (new Date() - movementStartTime) / 60000;
                            movementStartTime = null;
                            document.getElementById('movementTime').textContent = formatDuration(totalMovementTime);
                        }
                    }

                    // Update speed statistics
                    if (position.speed > maxSpeed) {
                        maxSpeed = position.speed;
                        document.getElementById('maxSpeed').textContent = maxSpeed.toFixed(2);
                    }

                    if (totalMovementTime > 0) {
                        const avgSpeed = totalDistance / (totalMovementTime / 60);
                        document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(2);
                    }

                    // Update location history
                    locationHistory.push(position);
                    if (locationHistory.length > MAX_HISTORY_POINTS) {
                        locationHistory.shift();
                    }

                    // Update map
                    updateMap(position.lat, position.lon);
                    
                } catch (error) {
                    console.error('Error processing GPS data:', error);
                }
            }
        });
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASI0J9rev9-NmWnNmSV8gqG_uOOR1-19Y&callback=initMap">
    </script>
</body>
</html>
